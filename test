// scripts/setupPolicies.js
import { createClient } from '@supabase/supabase-js'
import fs from 'fs'
import path from 'path'

// Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„ .env.local Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø³ØªÛŒ
const envPath = path.resolve(process.cwd(), '.env.local')
let envContent = {}

if (fs.existsSync(envPath)) {
  const content = fs.readFileSync(envPath, 'utf8')
  content.split('\n').forEach(line => {
    const match = line.match(/^([^=]+)=(.*)$/)
    if (match) {
      const key = match[1].trim()
      const value = match[2].trim()
      envContent[key] = value
    }
  })
} else {
  console.error('âŒ Error: .env.local file not found at', envPath)
  process.exit(1)
}

// Ú¯Ø±ÙØªÙ† Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù…Ø­ÛŒØ·ÛŒ
const supabaseUrl = envContent.NEXT_PUBLIC_SUPABASE_URL
const serviceRoleKey = envContent.SUPABASE_SERVICE_ROLE_KEY

if (!supabaseUrl || !serviceRoleKey) {
  console.error('âŒ Error: Missing environment variables')
  console.log('Found in .env.local:')
  console.log('NEXT_PUBLIC_SUPABASE_URL:', supabaseUrl ? 'âœ… Found' : 'âŒ Missing')
  console.log('SUPABASE_SERVICE_ROLE_KEY:', serviceRoleKey ? 'âœ… Found' : 'âŒ Missing')
  console.log('\nAvailable keys:', Object.keys(envContent))
  process.exit(1)
}

console.log('âœ… Environment variables loaded successfully')
console.log('Supabase URL:', supabaseUrl.substring(0, 20) + '...')
console.log('Service Role Key:', serviceRoleKey.substring(0, 10) + '...')

const supabase = createClient(supabaseUrl, serviceRoleKey)

async function setupPolicies() {
  console.log('ğŸš€ Starting RLS policies setup...')

  try {
    // ==================== Ø¬Ø¯ÙˆÙ„ profiles ====================
    console.log('\nğŸ“‹ Setting up policies for "profiles" table...')
    
    // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† RLS Ø¨Ø±Ø§ÛŒ profiles
    const { error: enableProfilesError } = await supabase.rpc('enable_rls', { table_name: 'profiles' })
    if (enableProfilesError && !enableProfilesError.message.includes('already enabled')) {
      console.error('Error enabling RLS for profiles:', enableProfilesError)
    }

    // Ø­Ø°Ù Ø³ÛŒØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ profiles
    const profilesPolicies = [
      'Users can view all profiles',
      'Users can insert their own profile',
      'Users can update own profile'
    ]
    
    for (const policy of profilesPolicies) {
      const { error } = await supabase.rpc('drop_policy_if_exists', { 
        table_name: 'profiles', 
        policy_name: policy 
      })
      if (error && !error.message.includes('policy')) {
        console.log(`Policy ${policy} doesn't exist or already removed`)
      }
    }

    // Ø§ÛŒØ¬Ø§Ø¯ Ø³ÛŒØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ profiles
    // 1. SELECT: Ù‡Ù…Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù†Ø¯ Ø¨Ø¨ÛŒÙ†Ù†Ø¯
    const { error: selectError } = await supabase.rpc('create_policy', {
      table_name: 'profiles',
      policy_name: 'Users can view all profiles',
      operation: 'SELECT',
      using_expression: 'true'
    })
    if (selectError) console.error('SELECT policy error:', selectError)
    
    // 2. INSERT: Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø§Ø­Ø±Ø§Ø² Ø´Ø¯Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù†Ø¯ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†Ù†Ø¯
    const { error: insertError } = await supabase.rpc('create_policy', {
      table_name: 'profiles',
      policy_name: 'Users can insert their own profile',
      operation: 'INSERT',
      check_expression: 'auth.uid() = auth_id OR auth.uid() IS NOT NULL'
    })
    if (insertError) console.error('INSERT policy error:', insertError)
    
    // 3. UPDATE: Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÙÙ‚Ø· Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù‡â€ŒØ±ÙˆØ² Ú©Ù†Ù†Ø¯
    const { error: updateError } = await supabase.rpc('create_policy', {
      table_name: 'profiles',
      policy_name: 'Users can update own profile',
      operation: 'UPDATE',
      using_expression: 'auth.uid() = auth_id'
    })
    if (updateError) console.error('UPDATE policy error:', updateError)

    console.log('âœ… Profiles policies setup complete')

    // ==================== Ø¬Ø¯ÙˆÙ„ chat_messages ====================
    console.log('\nğŸ“‹ Setting up policies for "chat_messages" table...')
    
    // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† RLS Ø¨Ø±Ø§ÛŒ chat_messages
    const { error: enableChatError } = await supabase.rpc('enable_rls', { table_name: 'chat_messages' })
    if (enableChatError && !enableChatError.message.includes('already enabled')) {
      console.error('Error enabling RLS for chat_messages:', enableChatError)
    }

    // Ø­Ø°Ù Ø³ÛŒØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ chat_messages
    const chatPolicies = [
      'Anyone can view messages',
      'Authenticated users can send messages',
      'Users can delete own messages'
    ]
    
    for (const policy of chatPolicies) {
      const { error } = await supabase.rpc('drop_policy_if_exists', { 
        table_name: 'chat_messages', 
        policy_name: policy 
      })
      if (error && !error.message.includes('policy')) {
        console.log(`Policy ${policy} doesn't exist or already removed`)
      }
    }

    // Ø§ÛŒØ¬Ø§Ø¯ Ø³ÛŒØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ chat_messages
    const chatPolicyResults = await Promise.all([
      supabase.rpc('create_policy', {
        table_name: 'chat_messages',
        policy_name: 'Anyone can view messages',
        operation: 'SELECT',
        using_expression: 'true'
      }),
      supabase.rpc('create_policy', {
        table_name: 'chat_messages',
        policy_name: 'Authenticated users can send messages',
        operation: 'INSERT',
        check_expression: 'auth.uid() IS NOT NULL'
      }),
      supabase.rpc('create_policy', {
        table_name: 'chat_messages',
        policy_name: 'Users can delete own messages',
        operation: 'DELETE',
        using_expression: 'auth.uid() = user_id'
      })
    ])

    chatPolicyResults.forEach((result, index) => {
      if (result.error) console.error(`Chat policy ${index} error:`, result.error)
    })

    console.log('âœ… Chat messages policies setup complete')

    // ==================== Ø¬Ø¯ÙˆÙ„ challenges ====================
    console.log('\nğŸ“‹ Setting up policies for "challenges" table...')
    
    // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† RLS Ø¨Ø±Ø§ÛŒ challenges
    const { error: enableChallengesError } = await supabase.rpc('enable_rls', { table_name: 'challenges' })
    if (enableChallengesError && !enableChallengesError.message.includes('already enabled')) {
      console.error('Error enabling RLS for challenges:', enableChallengesError)
    }

    // Ø­Ø°Ù Ø³ÛŒØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ challenges
    const challengePolicies = [
      'Anyone can view challenges',
      'Authenticated users can create challenges',
      'Users can join open challenges',
      'Creator can update own challenge'
    ]
    
    for (const policy of challengePolicies) {
      const { error } = await supabase.rpc('drop_policy_if_exists', { 
        table_name: 'challenges', 
        policy_name: policy 
      })
      if (error && !error.message.includes('policy')) {
        console.log(`Policy ${policy} doesn't exist or already removed`)
      }
    }

    // Ø§ÛŒØ¬Ø§Ø¯ Ø³ÛŒØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ challenges
    const challengePolicyResults = await Promise.all([
      supabase.rpc('create_policy', {
        table_name: 'challenges',
        policy_name: 'Anyone can view challenges',
        operation: 'SELECT',
        using_expression: 'true'
      }),
      supabase.rpc('create_policy', {
        table_name: 'challenges',
        policy_name: 'Authenticated users can create challenges',
        operation: 'INSERT',
        check_expression: 'auth.uid() = creator_id'
      }),
      supabase.rpc('create_policy', {
        table_name: 'challenges',
        policy_name: 'Users can join open challenges',
        operation: 'UPDATE',
        using_expression: 'auth.uid() = joiner_id AND (status = \'open\'::text)'
      }),
      supabase.rpc('create_policy', {
        table_name: 'challenges',
        policy_name: 'Creator can update own challenge',
        operation: 'UPDATE',
        using_expression: 'auth.uid() = creator_id'
      })
    ])

    challengePolicyResults.forEach((result, index) => {
      if (result.error) console.error(`Challenge policy ${index} error:`, result.error)
    })

    console.log('âœ… Challenges policies setup complete')

    console.log('\nğŸ‰ All RLS policies have been successfully configured!')
    
  } catch (error) {
    console.error('âŒ Error setting up policies:', error.message)
    console.error('Full error:', error)
    process.exit(1)
  }
}

// Ø§Ø¬Ø±Ø§ÛŒ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª
setupPolicies()