// scripts/setupPolicies.js
import { createClient } from '@supabase/supabase-js'
import 'dotenv/config'

// ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ØªØµØ§Ù„ - Ú©Ù„ÛŒØ¯ service_role Ø¨Ø±Ø§ÛŒ Ø¹Ù…Ù„ÛŒØ§Øª Ù…Ø¯ÛŒØ±ÛŒØªÛŒ Ù„Ø§Ø²Ù… Ø§Ø³Øª
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL
const serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY // Ú©Ù„ÛŒØ¯ ÙˆÛŒÚ˜Ù‡ Ø³Ø±ÙˆØ±

if (!supabaseUrl || !serviceRoleKey) {
  console.error('âŒ Error: Missing environment variables')
  console.log('Required: NEXT_PUBLIC_SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY')
  process.exit(1)
}

const supabase = createClient(supabaseUrl, serviceRoleKey)

async function setupPolicies() {
  console.log('ğŸš€ Starting RLS policies setup...')

  try {
    // ==================== Ø¬Ø¯ÙˆÙ„ profiles ====================
    console.log('\nğŸ“‹ Setting up policies for "profiles" table...')
    
    // 1. ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† RLS
    await supabase.rpc('enable_rls', { table_name: 'profiles' })
    
    // 2. Ø­Ø°Ù Ø³ÛŒØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ
    await supabase.rpc('drop_policy_if_exists', { 
      table_name: 'profiles', 
      policy_name: 'Users can view all profiles' 
    })
    await supabase.rpc('drop_policy_if_exists', { 
      table_name: 'profiles', 
      policy_name: 'Users can insert their own profile' 
    })
    await supabase.rpc('drop_policy_if_exists', { 
      table_name: 'profiles', 
      policy_name: 'Users can update own profile' 
    })

    // 3. Ø§ÛŒØ¬Ø§Ø¯ Ø³ÛŒØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯
    // Ø³ÛŒØ§Ø³Øª SELECT: Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù†Ø¯ Ù¾Ø±ÙˆÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø¨ÛŒÙ†Ù†Ø¯
    await supabase.rpc('create_policy', {
      table_name: 'profiles',
      policy_name: 'Users can view all profiles',
      operation: 'SELECT',
      using_expression: 'true'
    })

    // Ø³ÛŒØ§Ø³Øª INSERT: Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ø´Ø¯Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù†Ø¯ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†Ù†Ø¯
    await supabase.rpc('create_policy', {
      table_name: 'profiles',
      policy_name: 'Users can insert their own profile',
      operation: 'INSERT',
      check_expression: 'auth.uid() = auth_id OR auth.uid() IS NOT NULL'
    })

    // Ø³ÛŒØ§Ø³Øª UPDATE: Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÙÙ‚Ø· Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù‡â€ŒØ±ÙˆØ² Ú©Ù†Ù†Ø¯
    await supabase.rpc('create_policy', {
      table_name: 'profiles',
      policy_name: 'Users can update own profile',
      operation: 'UPDATE',
      using_expression: 'auth.uid() = auth_id'
    })

    console.log('âœ… Profiles policies setup complete')

    // ==================== Ø¬Ø¯ÙˆÙ„ chat_messages ====================
    console.log('\nğŸ“‹ Setting up policies for "chat_messages" table...')
    
    await supabase.rpc('enable_rls', { table_name: 'chat_messages' })
    
    // Ø­Ø°Ù Ø³ÛŒØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ
    const chatPolicies = [
      'Anyone can view messages',
      'Authenticated users can send messages',
      'Users can delete own messages'
    ]
    
    for (const policy of chatPolicies) {
      await supabase.rpc('drop_policy_if_exists', { 
        table_name: 'chat_messages', 
        policy_name: policy 
      })
    }

    // Ø§ÛŒØ¬Ø§Ø¯ Ø³ÛŒØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯
    await supabase.rpc('create_policy', {
      table_name: 'chat_messages',
      policy_name: 'Anyone can view messages',
      operation: 'SELECT',
      using_expression: 'true'
    })

    await supabase.rpc('create_policy', {
      table_name: 'chat_messages',
      policy_name: 'Authenticated users can send messages',
      operation: 'INSERT',
      check_expression: 'auth.uid() IS NOT NULL'
    })

    await supabase.rpc('create_policy', {
      table_name: 'chat_messages',
      policy_name: 'Users can delete own messages',
      operation: 'DELETE',
      using_expression: 'auth.uid() = user_id'
    })

    console.log('âœ… Chat messages policies setup complete')

    // ==================== Ø¬Ø¯ÙˆÙ„ challenges ====================
    console.log('\nğŸ“‹ Setting up policies for "challenges" table...')
    
    await supabase.rpc('enable_rls', { table_name: 'challenges' })
    
    // Ø­Ø°Ù Ø³ÛŒØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ
    const challengePolicies = [
      'Anyone can view challenges',
      'Authenticated users can create challenges',
      'Users can join open challenges',
      'Creator can update own challenge'
    ]
    
    for (const policy of challengePolicies) {
      await supabase.rpc('drop_policy_if_exists', { 
        table_name: 'challenges', 
        policy_name: policy 
      })
    }

    // Ø§ÛŒØ¬Ø§Ø¯ Ø³ÛŒØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯
    await supabase.rpc('create_policy', {
      table_name: 'challenges',
      policy_name: 'Anyone can view challenges',
      operation: 'SELECT',
      using_expression: 'true'
    })

    await supabase.rpc('create_policy', {
      table_name: 'challenges',
      policy_name: 'Authenticated users can create challenges',
      operation: 'INSERT',
      check_expression: 'auth.uid() = creator_id'
    })

    await supabase.rpc('create_policy', {
      table_name: 'challenges',
      policy_name: 'Users can join open challenges',
      operation: 'UPDATE',
      using_expression: 'auth.uid() = joiner_id AND status = "open"'
    })

    await supabase.rpc('create_policy', {
      table_name: 'challenges',
      policy_name: 'Creator can update own challenge',
      operation: 'UPDATE',
      using_expression: 'auth.uid() = creator_id'
    })

    console.log('âœ… Challenges policies setup complete')

    console.log('\nğŸ‰ All RLS policies have been successfully configured!')
    
  } catch (error) {
    console.error('âŒ Error setting up policies:', error.message)
    console.error('Full error:', error)
    process.exit(1)
  }
}

// Ø§Ø¬Ø±Ø§ÛŒ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª
setupPolicies()